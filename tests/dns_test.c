// vim: sts=2
/*
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; version 2 dated June, 1991, or
   (at your option) version 3 dated 29 June, 2007.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/* DHCP protocol definitions and configuration lookup tests.
 *
 * Because dnsmasq uses die() function to report failures,
 * unsupported options cannot be tested now. */

#include "test.h"
#include <stdlib.h>

struct dns_packet {
  union {
    struct dns_header *header;
    unsigned char *data;
  };
  size_t len;
};

#define FREE_NULL(var)  free(var); var = NULL
#define MAKE_PACKET(packet, d) do { (packet).len = sizeof(d); (packet).data = (d); } while (0)


static void daemon_allocate()
{
#ifdef HAVE_DNSSEC
  /* copy from main() function */
  if (option_bool(OPT_DNSSEC_VALID))
    {
      /* Note that both /000 and '.' are allowed within labels. These get
	 represented in presentation format using NAME_ESCAPE as an escape
	 character when in DNSSEC mode.
	 In theory, if all the characters in a name were /000 or
	 '.' or NAME_ESCAPE then all would have to be escaped, so the
	 presentation format would be twice as long as the spec.

	 daemon->namebuff was previously allocated by the option-reading
	 code before we knew if we're in DNSSEC mode, so reallocate here. */
      free(daemon->namebuff);
      daemon->namebuff = safe_malloc(MAXDNAME * 2);
      daemon->keyname = safe_malloc(MAXDNAME * 2);
      daemon->workspacename = safe_malloc(MAXDNAME * 2);
      /* one char flag per possible RR in answer section (may get extended). */
      daemon->rr_status_sz = 64;
      daemon->rr_status = safe_malloc(sizeof(*daemon->rr_status) * daemon->rr_status_sz);
    }
#endif
  cache_init();
  cache_reload(); /**< Initializes trust anchor records. */
}


static void daemon_free()
{
#ifdef HAVE_DNSSEC
  if (option_bool(OPT_DNSSEC_VALID))
    {
      free(daemon->namebuff);
      daemon->namebuff = safe_malloc(MAXDNAME);
      FREE_NULL(daemon->keyname);
      FREE_NULL(daemon->workspacename);
      /* one char flag per possible RR in answer section (may get extended). */
      daemon->rr_status_sz = 0;
      FREE_NULL(daemon->rr_status);
    }
#endif
}


static void test_thekelleys(void **state)
{
  char *argv[] = {
	  ARGV_START,
	  "--no-resolv",
  };
  unsigned char reply[] = {
  0x1e, 0x78, 0x81, 0x80,  0x0, 0x1, 0x0, 0x2,  0x0, 0x0, 0x0, 0x0, // header
  0x3, 0x77, 0x77, 0x77, 0xa, 0x74, 0x68, 0x65, 0x6b, 0x65, 0x6c,
  0x6c, 0x65, 0x79, 0x73, 0x3, 0x6f, 0x72, 0x67, 0x2, 0x75, 0x6b, 0x0, 0x0, 0x1, 0x0, 0x1, 0xc0, 0xc, 0x0, 0x5, 0x0, 0x1, 0x0, 0x0,
  0xa3, 0xb1, 0x0, 0x2, 0xc0, 0x10, 0xc0, 0x10, 0x0, 0x1, 0x0, 0x1, 0x0, 0x0, 0xa3, 0xb1, 0x0, 0x4, 0xd5, 0x8a, 0x6d, 0x6b
  };
  struct dns_packet pkt = { .data=reply, .len=sizeof(reply) };
  unsigned char *p = (unsigned char *)(pkt.header+1);
  unsigned char *psave;
  int rc;

  (void) state;
  testcore_main(ARRAY_SIZE(argv), argv);
  daemon_allocate();

  rc = extract_name(pkt.header, pkt.len, &p, daemon->namebuff, 1, 4);
  assert_true(rc);
  assert_string_equal(daemon->namebuff, "www.thekelleys.org.uk");

  p += 4;
  psave = p;
  strcpy(daemon->namebuff, "wWw.TheKelleys.org.UK");
  rc = extract_name(pkt.header, pkt.len, &p, daemon->namebuff, 0, 4);
  assert_int_equal(rc, 1);

  strcpy(daemon->namebuff, "wwX.thekelleys.org.uk");
  rc = extract_name(pkt.header, pkt.len, &psave, daemon->namebuff, 0, 4);
  assert_int_equal(rc, 2);

  daemon_free();
}

#ifdef HAVE_DNSSEC
static void test_dnssec_validation(void **state)
{
  char *argv[] = {
	  ARGV_START,
	  "--dnssec",
	  "--trust-anchor=.,20326,8,2,E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D",
	  "--log-queries",
	  "--no-resolv",
  };

  /* dig +dnssec . NS reply */
  unsigned char reply_ns[] = {
  0x21, 0x31, 0x81, 0xa0, 0x0, 0x1, 0x0, 0xe, 0x0, 0x0, 0x0, 0x1, // Header
  0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x14, 0x1, 0x64, 0xc, 0x72, 0x6f, 0x6f, 0x74, 
  0x2d, 0x73, 0x65, 0x72, 0x76, 0x65, 0x72, 0x73, 0x3, 0x6e, 0x65, 0x74, 0x0, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 
  0x4, 0x1, 0x65, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x66, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 
  0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x67, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x68, 
  0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x69, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 
  0xa7, 0xeb, 0x0, 0x4, 0x1, 0x6a, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x6b, 0xc0, 0x1e, 0x0, 
  0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x6c, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 
  0x1, 0x6d, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x61, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 
  0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x62, 0xc0, 0x1e, 0x0, 0x0, 0x2, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x0, 0x4, 0x1, 0x63, 0xc0, 
  0x1e, 0x0, 0x0, 0x2e, 0x0, 0x1, 0x0, 0x6, 0xa7, 0xeb, 0x1, 0x13, 0x0, 0x2, 0x8, 0x0, 0x0, 0x7, 0xe9, 0x0, 0x5f, 0x9e, 0x40, 0xd0, 
  0x5f, 0x8d, 0xf, 0x40, 0x66, 0x4, 0x0, 0x6a, 0xc2, 0x2d, 0xda, 0x4b, 0x1d, 0x9f, 0xb, 0x93, 0xbd, 0x6, 0x12, 0xb1, 0xee, 0x48, 
  0x30, 0xd4, 0x66, 0xf, 0xbe, 0xe4, 0x3b, 0xaa, 0xa9, 0xd6, 0xb2, 0x69, 0x73, 0xee, 0x80, 0x11, 0x2b, 0x8e, 0xe6, 0x8a, 0x2d, 0x7, 
  0x4a, 0x82, 0x47, 0xa3, 0x99, 0xb9, 0x61, 0x51, 0x63, 0x80, 0x44, 0xee, 0x48, 0xf0, 0x21, 0x45, 0xed, 0x43, 0x7d, 0x72, 0x15, 0x7d, 
  0x2, 0x75, 0xad, 0x19, 0x87, 0x22, 0xfd, 0x75, 0x61, 0xcb, 0xd0, 0x8a, 0x53, 0x53, 0x89, 0xb6, 0x48, 0xbe, 0x7f, 0x51, 0xbd, 0xcd, 
  0x9f, 0xb0, 0xd0, 0x13, 0x14, 0xe6, 0x13, 0x6a, 0x88, 0x4b, 0x51, 0x34, 0xb, 0x99, 0xe9, 0x40, 0xc0, 0x65, 0xc5, 0xc5, 0x8a, 0x2f, 
  0xc6, 0xc7, 0x70, 0x2a, 0xb8, 0x6c, 0xb3, 0x88, 0x5c, 0xd3, 0x0, 0xe0, 0xb9, 0x6c, 0xc9, 0x77, 0x2, 0x27, 0xd0, 0x66, 0x12, 0x4d, 
  0xa6, 0x85, 0xea, 0x80, 0xfb, 0x54, 0xde, 0x6b, 0x39, 0x33, 0x90, 0x1c, 0xb0, 0x6d, 0xb4, 0xe6, 0xe9, 0x1, 0x41, 0x89, 0xa4, 0x9a, 
  0x82, 0x25, 0xb8, 0xbf, 0x1c, 0xd0, 0x15, 0x61, 0x3b, 0xc, 0x87, 0xbd, 0x2c, 0xa5, 0xb2, 0x72, 0x44, 0x77, 0x28, 0xdc, 0xbb, 0x3d, 
  0xfc, 0x90, 0xcf, 0x2f, 0x80, 0x48, 0x4d, 0xa1, 0x35, 0xd9, 0x65, 0xea, 0xdc, 0xa8, 0x96, 0x8, 0x52, 0x24, 0x3e, 0x8a, 0xa6, 0x44, 
  0x5b, 0xb2, 0xe5, 0x78, 0x3f, 0x77, 0x27, 0x39, 0xb0, 0xf9, 0x83, 0xd0, 0x32, 0xf0, 0x4c, 0x36, 0x58, 0x40, 0x12, 0x3b, 0x52, 0xb6, 
  0xe9, 0xc, 0xe, 0xe5, 0x27, 0xad, 0x4b, 0xc5, 0xaf, 0x84, 0xde, 0xa1, 0x53, 0xbc, 0x17, 0x1, 0x59, 0x8f, 0x11, 0xad, 0xed, 0x5a, 
  0x56, 0x4d, 0xef, 0x3, 0x6c, 0x5c, 0x5a, 0xd9, 0x6f, 0xe0, 0x2e, 0x9, 0xf, 0x37, 0xaf, 0x19, 0xa2, 0xa8, 0xd6, 0x5f, 0xa7, 0x0, 
  0x0, 0x29, 0x4, 0xd0, 0x0, 0x0, 0x80, 0x0, 0x0, 0x0
  };

  unsigned char reply_dnskey[] = {
  0xaa, 0x34, 0x81, 0xa0, 0x0, 0x1, 0x0, 0x3, 0x0, 0x0, 0x0, 0x1, // Header
  0x0, 0x0, 0x30, 0x0, 0x1, 0x0, 0x0, 0x30, 0x0, 0x1, 0x0, 0x2,
  0x10, 0x6e, 0x1, 0x8, 0x1, 0x1, 0x3, 0x8, 0x3, 0x1, 0x0, 0x1, 0xac, 0xff, 0xb4, 0x9, 0xbc, 0xc9, 0x39, 0xf8, 0x31, 0xf7, 0xa1,
  0xe5, 0xec, 0x88, 0xf7, 0xa5, 0x92, 0x55, 0xec, 0x53, 0x4, 0xb, 0xe4, 0x32, 0x2, 0x73, 0x90, 0xa4, 0xce, 0x89, 0x6d, 0x6f, 0x90,
  0x86, 0xf3, 0xc5, 0xe1, 0x77, 0xfb, 0xfe, 0x11, 0x81, 0x63, 0xaa, 0xec, 0x7a, 0xf1, 0x46, 0x2c, 0x47, 0x94, 0x59, 0x44, 0xc4, 0xe2,
  0xc0, 0x26, 0xbe, 0x5e, 0x98, 0xbb, 0xcd, 0xed, 0x25, 0x97, 0x82, 0x72, 0xe1, 0xe3, 0xe0, 0x79, 0xc5, 0x9, 0x4d, 0x57, 0x3f, 0xe,
  0x83, 0xc9, 0x2f, 0x2, 0xb3, 0x2d, 0x35, 0x13, 0xb1, 0x55, 0xb, 0x82, 0x69, 0x29, 0xc8, 0xd, 0xd0, 0xf9, 0x2c, 0xac, 0x96, 0x6d,
  0x17, 0x76, 0x9f, 0xd5, 0x86, 0x7b, 0x64, 0x7c, 0x3f, 0x38, 0x2, 0x9a, 0xbd, 0xc4, 0x81, 0x52, 0xeb, 0x8f, 0x20, 0x71, 0x59, 0xec,
  0xc5, 0xd2, 0x32, 0xc7, 0xc1, 0x53, 0x7c, 0x79, 0xf4, 0xb7, 0xac, 0x28, 0xff, 0x11, 0x68, 0x2f, 0x21, 0x68, 0x1b, 0xf6, 0xd6, 0xab,
  0xa5, 0x55, 0x3, 0x2b, 0xf6, 0xf9, 0xf0, 0x36, 0xbe, 0xb2, 0xaa, 0xa5, 0xb3, 0x77, 0x8d, 0x6e, 0xeb, 0xfb, 0xa6, 0xbf, 0x9e, 0xa1,
  0x91, 0xbe, 0x4a, 0xb0, 0xca, 0xea, 0x75, 0x9e, 0x2f, 0x77, 0x3a, 0x1f, 0x90, 0x29, 0xc7, 0x3e, 0xcb, 0x8d, 0x57, 0x35, 0xb9, 0x32,
  0x1d, 0xb0, 0x85, 0xf1, 0xb8, 0xe2, 0xd8, 0x3, 0x8f, 0xe2, 0x94, 0x19, 0x92, 0x54, 0x8c, 0xee, 0xd, 0x67, 0xdd, 0x45, 0x47, 0xe1,
  0x1d, 0xd6, 0x3a, 0xf9, 0xc9, 0xfc, 0x1c, 0x54, 0x66, 0xfb, 0x68, 0x4c, 0xf0, 0x9, 0xd7, 0x19, 0x7c, 0x2c, 0xf7, 0x9e, 0x79, 0x2a,
  0xb5, 0x1, 0xe6, 0xa8, 0xa1, 0xca, 0x51, 0x9a, 0xf2, 0xcb, 0x9b, 0x5f, 0x63, 0x67, 0xe9, 0x4c, 0xd, 0x47, 0x50, 0x24, 0x51, 0x35,
  0x7b, 0xe1, 0xb5, 0x0, 0x0, 0x30, 0x0, 0x1, 0x0, 0x2, 0x10, 0x6e, 0x1, 0x8, 0x1, 0x0, 0x3, 0x8, 0x3, 0x1, 0x0, 0x1, 0xf0, 0xbf,
  0xe8, 0x72, 0xc2, 0x97, 0xb, 0x2c, 0xea, 0x1e, 0xeb, 0x3d, 0xfa, 0x6, 0xd9, 0xc9, 0x62, 0xbf, 0x8f, 0xd2, 0x3c, 0x94, 0x5d, 0xd8,
  0x73, 0xc4, 0x82, 0x54, 0x6c, 0xbc, 0xa6, 0x51, 0x6c, 0xf3, 0xf6, 0x44, 0xb7, 0xe2, 0xa1, 0xb7, 0x80, 0x91, 0xcc, 0xdc, 0x76, 0xa6,
  0x83, 0xe6, 0xaf, 0x25, 0xa0, 0x4b, 0x75, 0xe2, 0x57, 0x13, 0x80, 0x3a, 0xb0, 0xcc, 0xe2, 0x12, 0x67, 0x76, 0x2f, 0x49, 0x59, 0xc,
  0xe0, 0x94, 0x4c, 0x17, 0x2, 0xb3, 0x72, 0x3b, 0xa4, 0x2a, 0x8e, 0x42, 0xb0, 0x35, 0x5b, 0x32, 0x68, 0x53, 0xf, 0x40, 0xb4, 0xcb,
  0x15, 0x88, 0x9, 0x14, 0x35, 0x33, 0xe6, 0x39, 0xfd, 0x79, 0x19, 0x1, 0x3e, 0xe6, 0xb7, 0x87, 0x1b, 0xdd, 0xf5, 0x9c, 0x37, 0xdc,
  0x60, 0xca, 0xad, 0x70, 0x11, 0x74, 0x17, 0xfb, 0x37, 0x4b, 0x40, 0x7a, 0xcd, 0x11, 0x54, 0x12, 0x88, 0xbe, 0x52, 0xa0, 0xe, 0x5c,
  0x3a, 0xd0, 0x92, 0xa1, 0xe, 0x39, 0x9f, 0xc6, 0xca, 0xd, 0x77, 0x70, 0xff, 0x48, 0xe3, 0x3f, 0xd4, 0x70, 0xd4, 0x55, 0x4a, 0xb1,
  0xdc, 0xcb, 0x56, 0x44, 0x12, 0xad, 0x53, 0x26, 0xf2, 0x4d, 0xf4, 0x59, 0x49, 0x7, 0x9b, 0xf4, 0x8a, 0xfe, 0x7f, 0xfd, 0xe7, 0x82,
  0x84, 0x36, 0x47, 0x50, 0x38, 0xe, 0x8b, 0x8b, 0x6b, 0xce, 0xf6, 0x78, 0x9c, 0x41, 0xd7, 0xa0, 0xc8, 0x9, 0x3, 0x78, 0xd2, 0x42,
  0x74, 0xf3, 0x7f, 0xa7, 0x78, 0xc4, 0x84, 0x24, 0xd0, 0x2f, 0x23, 0xb8, 0x2, 0x50, 0x26, 0xc9, 0xa3, 0xdc, 0xc, 0x77, 0x9e, 0xa3,
  0xb3, 0x97, 0xaf, 0xf5, 0x6c, 0x62, 0xee, 0xd, 0x4c, 0x37, 0x5e, 0xf6, 0x10, 0x6e, 0x4b, 0x4c, 0xf1, 0xfe, 0xb7, 0xb0, 0xf, 0xe0,
  0x6f, 0x4a, 0x79, 0xa7, 0x34, 0x73, 0x66, 0x1f, 0x61, 0x63, 0x50, 0x4f, 0x0, 0x0, 0x2e, 0x0, 0x1, 0x0, 0x2, 0x10, 0x6e, 0x1, 0x13,
  0x0, 0x30, 0x8, 0x0, 0x0, 0x2, 0xa3, 0x0, 0x5f, 0x9d, 0xfa, 0x80, 0x5f, 0x82, 0x4b, 0x0, 0x4f, 0x66, 0x0, 0x8a, 0x51, 0x66, 0xa9,
  0x41, 0x98, 0xbb, 0xa5, 0x77, 0xf4, 0xfd, 0x34, 0x5f, 0xb4, 0x85, 0x9d, 0x6d, 0x94, 0x49, 0x44, 0x7e, 0x2a, 0x26, 0x42, 0xcf, 0xf2,
  0x98, 0x47, 0xdd, 0x15, 0x49, 0xb6, 0xe6, 0xe6, 0xb, 0xfb, 0xce, 0xe8, 0x31, 0x67, 0xd8, 0xed, 0xf8, 0xdf, 0x6a, 0xbf, 0x68, 0xe,
  0xb8, 0xfc, 0x39, 0x24, 0x25, 0x52, 0x3c, 0xf0, 0x46, 0xab, 0x55, 0x23, 0x29, 0xb0, 0xbb, 0xcb, 0x9, 0x3c, 0xaf, 0xab, 0xc7, 0x1a,
  0xc, 0x1d, 0x72, 0x5d, 0xc2, 0xdf, 0xaf, 0xdd, 0x91, 0xc2, 0xca, 0x4b, 0x46, 0xdf, 0x45, 0x77, 0x51, 0xa5, 0x2, 0xa, 0x8a, 0x79,
  0x40, 0xb8, 0xcb, 0x62, 0x6f, 0x90, 0xc9, 0x59, 0xd1, 0xc4, 0x3f, 0x3, 0xd1, 0x55, 0x60, 0x2a, 0xb4, 0x31, 0x34, 0x3a, 0x4c, 0xce,
  0xad, 0x32, 0x18, 0x53, 0xd7, 0x71, 0x49, 0xc2, 0x10, 0xb9, 0xc9, 0xc2, 0x47, 0xc4, 0x23, 0x37, 0xaa, 0x85, 0x39, 0x19, 0xee, 0x26,
  0x9d, 0x35, 0xbb, 0x3b, 0x71, 0x1b, 0x6c, 0xbb, 0x2e, 0xbe, 0xd6, 0xae, 0xcf, 0xaf, 0x70, 0xf6, 0xd7, 0x73, 0xac, 0xb3, 0xa9, 0x34,
  0xa4, 0xa9, 0x68, 0x41, 0xaf, 0xa6, 0x17, 0x5e, 0xb0, 0xb2, 0x35, 0xd2, 0x86, 0x9d, 0x60, 0x9e, 0x62, 0x6a, 0x4, 0xff, 0x22, 0x1f,
  0xd4, 0x60, 0x23, 0xc3, 0x6b, 0xe1, 0x90, 0xa7, 0x31, 0x14, 0x2b, 0x53, 0xa1, 0x46, 0x65, 0x1c, 0x9f, 0x44, 0xd2, 0xd9, 0x41, 0x36,
  0x4c, 0xe6, 0x6e, 0xe7, 0x17, 0xa5, 0xe6, 0x45, 0x87, 0x7e, 0x9c, 0x14, 0x36, 0xd9, 0x43, 0x80, 0x4d, 0x10, 0xa4, 0xe5, 0x5d, 0xfa,
  0xfa, 0xcf, 0x0, 0x2c, 0x58, 0x3a, 0x80, 0xa3, 0xfb, 0x5b, 0x25, 0xeb, 0xd0, 0x27, 0x1b, 0xbc, 0x40, 0x23, 0x74, 0xba, 0x33, 0x2,
  0x90, 0xad, 0xcd, 0x75, 0x4f, 0x23, 0x80, 0x37, 0x4c, 0xdc, 0x0, 0x0, 0x29, 0x4, 0xd0, 0x0, 0x0, 0x80, 0x0, 0x0, 0x0
  };
  
  int r;
  time_t now = 1603186099;
  char name[MAXDNAME*2] = "";
  char keyname[MAXDNAME*2] = "";
  int class = 0x482988;
  int check_unsigned = 1;
  struct dns_packet ns, dnskey;

  (void) state;

  testcore_main(ARRAY_SIZE(argv), argv);

  daemon_allocate();
  MAKE_PACKET(ns, reply_ns);
  MAKE_PACKET(dnskey, reply_dnskey);

  r = dnssec_validate_reply (now, ns.header, ns.len, name, keyname,
			     &class, check_unsigned, NULL, NULL, NULL);
  /* Cannot test well validation with fixed source packets.
   * Their signatures would get bogus in a few weeks. */
  assert_in_range(r, STAT_BOGUS, STAT_NEED_DS);

  r = dnssec_validate_by_ds(now, dnskey.header, dnskey.len, name, keyname, class);
  assert_in_range(r, STAT_BOGUS, STAT_NEED_DS);

  r = dnssec_validate_reply (now, ns.header, ns.len, name, keyname,
			     &class, check_unsigned, NULL, NULL, NULL);
  assert_in_range(r, STAT_BOGUS, STAT_NEED_DS);
  daemon_free();
}
#endif

int main(int argc, char *argv[])
{
  const struct CMUnitTest tests[] = {
    cmocka_unit_test(test_thekelleys),
#ifdef HAVE_DNSSEC
    cmocka_unit_test(test_dnssec_validation),
#endif
  };

  return cmocka_run_group_tests(tests, NULL, NULL);
}
